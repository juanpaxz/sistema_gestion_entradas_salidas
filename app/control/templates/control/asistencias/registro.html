{% extends 'control/bootstrap_base.html' %}
{% load static %}

{% block title %}Registro de Asistencia{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'control/css/theme.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>

    .kiosk-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }

    .brand-logo-lg {
        width: 70px;
        height: 70px;
        font-size: 2rem;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        /* Usar degradado sutil en tonos del color de marca rojo */
        background: linear-gradient(135deg, #c70f02, #b80d02);
        color: #ffffff;
        font-weight: 800;
        /* Sombra adaptada al color rojo */
        box-shadow: 0 10px 25px rgba(199, 15, 2, 0.12);
        margin-bottom: 1rem; 
    }
    
    /* Estilo del Reloj */
    .clock-display {
        margin-bottom: 1.5rem; 
    }
    
    #current-time {
        font-size: 4.5rem; 
        font-weight: 700;
        line-height: 1;
        color: #c70f02;
        letter-spacing: -2px;
    }
    
    #current-date {
        font-size: 1.5rem; 
        font-weight: 300;
        color: #000000;
    }
    
    @media (max-width: 576px) {
        #current-time { font-size: 3.5rem; }
        #current-date { font-size: 1.15rem; }
    }

    .register-form {
        max-width: 360px; /* Más compacto */
        width: 100%;
        background-color: #fff;
        padding: 1.5rem; 
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border: 1px solid #e0e0e0;
    }
    
    
    .register-form .form-label {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .register-form .form-control-lg {
        text-align: center;
        font-weight: 600;
        letter-spacing: 1px;
        background-color: #f4f7f6;
        border-width: 2px;
    }
    

    .register-form .btn-lg {
        padding-top: 0.7rem;
        padding-bottom: 0.7rem;
        font-size: 1.1rem; 
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    /* Asegurar colores correctos: entrada = verde oscuro, salida = rojo oscuro */
    #btn-entrada {
        background-color: #157347 !important;
        border-color: #0f5a3b !important;
        color: #ffffff !important;
        box-shadow: 0 6px 14px rgba(21,115,71,0.12);
    }
    #btn-entrada:hover {
        background-color: #13603a !important;
        border-color: #0e4f33 !important;
    }

    #btn-salida {
        background-color: #a60d02 !important;
        border-color: #8f0b02 !important;
        color: #ffffff !important;
        box-shadow: 0 6px 14px rgba(166,13,2,0.12);
    }
    #btn-salida:hover {
        background-color: #8f0b02 !important;
        border-color: #7a0902 !important;
    }
</style>
{% endblock %}

{% block content %}

<!-- theme toggle removed -->


<div class="kiosk-container">

    <div class="brand-logo-lg">
        <!-- Logo: reemplazamos el texto 'CI' por la imagen de la marca -->
        <img src="{% static 'control/img/logo.jpg' %}" alt="Logo" style="width:100%; height:100%; object-fit:contain; border-radius:12px; display:block;">
    </div>

    <div class="title" style="color: #c70f02; font-weight: 1000; font-size: 1.5rem; margin-bottom: 1rem;">
        Escuela del Servicio Social
    </div>

    <div class="clock-display text-center">
        <h1 id="current-time" class="display-1 fw-bold"></h1>
        <p id="current-date" class="opacity-75"></p>
    </div>

    <div class="register-form">
        <div class="mb-3 text-start">
            <label for="rfc" class="form-label">RFC</label>
            <input id="rfc" name="rfc" class="form-control form-control-lg" placeholder="Ingrese RFC" {% if empleado %}value="{{ empleado.rfc }}"{% endif %} />
        </div>
        
        <div class="d-grid gap-3 mt-3">
            <button id="btn-entrada" class="btn btn-primary btn-lg">
                <i class="bi bi-box-arrow-in-right"></i>
                Registrar Entrada
            </button>   
            <button id="btn-salida" class="btn btn-secondary btn-lg">
                <i class="bi bi-box-arrow-out-right"></i>
                Registrar Salida
            </button>
        </div>

        <div id="mensaje" class="alert mt-3" style="display: none; padding: 0.75rem 1rem; font-size: 0.9rem;"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // --- LÓGICA DEL RELOJ ---
    function updateClock() {
        const now = new Date();
        // Usar formato 12 horas
        const timeOpts = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
        const dateOpts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

        // Obtener cadena local y normalizar AM/PM para consistencia (p. ej. 'a. m.' -> 'AM')
        let timeString = now.toLocaleTimeString('es-MX', timeOpts);
        // Reemplazar variantes locales de a. m./p. m. por AM/PM (case-insensitive)
        timeString = timeString.replace(/\s?a\.?\s?m\.?/i, ' AM').replace(/\s?p\.?\s?m\.?/i, ' PM');

        document.getElementById('current-time').textContent = timeString;

        // Capitalizar la primera letra del día
        let dateString = now.toLocaleDateString('es-MX', dateOpts);
        document.getElementById('current-date').textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
    }

    setInterval(updateClock, 1000);
    updateClock();

    // --- LÓGICA DE REGISTRO (FETCH) ---
    function mostrarMensaje(mensaje, tipo) {
        const alertDiv = document.getElementById('mensaje');
        alertDiv.textContent = mensaje;
        alertDiv.className = `alert alert-${tipo} mt-3`;
        alertDiv.style.cssText = "display: block; padding: 0.75rem 1rem; font-size: 0.9rem;";
    }

    document.getElementById('btn-entrada').addEventListener('click', function() {
        const rfcVal = document.getElementById('rfc').value.trim();
        if (!rfcVal) {
            mostrarMensaje('Por favor ingresa tu RFC antes de registrar la entrada.', 'warning');
            return;
        }

        fetch('{% url "control:registrar_entrada" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
            },
            body: new URLSearchParams({ rfc: rfcVal })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                mostrarMensaje(`${data.message} - ${data.hora}`, 'success');
            } else {
                mostrarMensaje(data.message, 'danger');
            }
        })
        .catch(error => {
            mostrarMensaje('Error al registrar entrada: ' + error, 'danger');
        });
    });

    document.getElementById('btn-salida').addEventListener('click', function() {
        const rfcVal = document.getElementById('rfc').value.trim();
        if (!rfcVal) {
            mostrarMensaje('Por favor ingresa tu RFC antes de registrar la salida.', 'warning');
            return;
        }

        fetch('{% url "control:registrar_salida" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
            },
            body: new URLSearchParams({ rfc: rfcVal })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                mostrarMensaje(`${data.message} - ${data.hora}`, 'success');
            } else {
                mostrarMensaje(data.message, 'danger');
            }
        })
        .catch(error => {
            mostrarMensaje('Error al registrar salida: ' + error, 'danger');
        });
    });

        // dark mode logic removed
</script>
{% endblock %}